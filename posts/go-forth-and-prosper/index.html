<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script><link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Go Forth and Prosper | João G. Sousa</title>
<link rel=canonical href=//www.jgsousa.com/posts/go-forth-and-prosper/><meta name=description content="I’m João. I enjoy computers, data, math."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Go Forth and Prosper"><meta property="og:description" content="TL;DR Split input on white space Numbers get added to a stack, words get executed Pre-define some words in the interpreter Write new words in Forth Background For last year&rsquo;s Advent of Code, in one of those should-really-stop-overestimating-my-skills type of situations, I took on the challenge of using a different programming language every day. Needless to say, a day quickly took on a looser definition as the problems got progressively harder and the languages more esoteric."><meta property="og:type" content="article"><meta property="og:url" content="//www.jgsousa.com/posts/go-forth-and-prosper/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-06T22:50:00+01:00"><meta property="article:modified_time" content="2023-07-06T22:50:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Forth and Prosper"><meta name=twitter:description content="TL;DR Split input on white space Numbers get added to a stack, words get executed Pre-define some words in the interpreter Write new words in Forth Background For last year&rsquo;s Advent of Code, in one of those should-really-stop-overestimating-my-skills type of situations, I took on the challenge of using a different programming language every day. Needless to say, a day quickly took on a looser definition as the problems got progressively harder and the languages more esoteric."><link rel=stylesheet href=//www.jgsousa.com/css/styles.7c754dee4bfc873743b12288cf94eadcfd3bee1f2cff5a106753b8047879ac5195c8d8ad90f6d73f12e9c841696c51a0abdeae8394e3eb3079f310f418ddf9ec.css integrity="sha512-fHVN7kv8hzdDsSKIz5Tq3P077h8s/1oQZ1O4BHh5rFGVyNitkPbXPxLpyEFpbFGgq96ug5Tj6zB58xD0GN357A=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=//www.jgsousa.com/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=//www.jgsousa.com/posts/homebrew-poetry-python-versions/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&text=Go%20Forth%20and%20Prosper" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&title=Go%20Forth%20and%20Prosper" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&is_video=false&description=Go%20Forth%20and%20Prosper" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Go%20Forth%20and%20Prosper&body=Check out this article: %2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&title=Go%20Forth%20and%20Prosper" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&title=Go%20Forth%20and%20Prosper" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&name=Go%20Forth%20and%20Prosper&description=TL%3bDR%20Split%20input%20on%20white%20space%20Numbers%20get%20added%20to%20a%20stack%2c%20words%20get%20executed%20Pre-define%20some%20words%20in%20the%20interpreter%20Write%20new%20words%20in%20Forth%20Background%20For%20last%20year%26rsquo%3bs%20Advent%20of%20Code%2c%20in%20one%20of%20those%20should-really-stop-overestimating-my-skills%20type%20of%20situations%2c%20I%20took%20on%20the%20challenge%20of%20using%20a%20different%20programming%20language%20every%20day.%20Needless%20to%20say%2c%20a%20day%20quickly%20took%20on%20a%20looser%20definition%20as%20the%20problems%20got%20progressively%20harder%20and%20the%20languages%20more%20esoteric." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&t=Go%20Forth%20and%20Prosper" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#background>Background</a></li><li><a href=#learn-forth>Learn Forth</a></li><li><a href=#the-interpreter>The Interpreter</a></li><li><a href=#a-stack-of-numbers>A Stack of Numbers</a></li><li><a href=#a-dictionary-of-words>A Dictionary of Words</a></li><li><a href=#some-more-words>Some More Words</a></li><li><a href=#in-your-own-words>In Your Own Words</a></li><li><a href=#last-words>Last Words</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Go Forth and Prosper</h1><div class=meta><div class=postdate><time datetime="2023-07-06 22:50:00 +0100 +0100" itemprop=datePublished>2023-07-06</time></div></div></header><div class=content itemprop=articleBody><h2 id=tldr>TL;DR</h2><ul><li>Split input on white space</li><li>Numbers get added to a stack, words get executed</li><li>Pre-define some words in the interpreter</li><li>Write new words in Forth</li></ul><h2 id=background>Background</h2><p>For last year&rsquo;s <a href=https://adventofcode.com/2022>Advent of Code</a>, in one of those should-really-stop-overestimating-my-skills type of situations, I took on the challenge of using a different programming language every day. Needless to say, a day quickly took on a looser definition as the problems got progressively harder and the languages more esoteric. But I had tons of fun, and learned a lot.</p><p>A few languages stood out to me, and I made a promise to myself that I&rsquo;do something more with them. Unfortunately, it&rsquo;s hard to convince my employer of the merits of <a href=https://github.com/jotinha/advent-of-code-2022/blob/main/23/main.apl>glyph based code</a> or that our industry really made a mistake moving away from <a href=https://github.com/jotinha/advent-of-code-2022/blob/main/17/main.wat>assembly</a> in the first place, so I had to commit to some sort of personal project if I wanted to keep that promise.</p><p>This is where <strong>Forth</strong> comes in. A very simple, yet remarkably powerful, language that is easy to build a compiler for. So much so, that doing it has become a rite of passage for anyone interested in learning about compilers or programming languages in general. And that&rsquo;s what we&rsquo;re going to try to do here!</p><p>To be clear, our goal is not a fully featured, standards compliant, Forth. I&rsquo;ll be happy if we have enough of it to run <a href=https://github.com/jotinha/advent-of-code-2022/blob/main/20/main.fth>this code</a>. But that&rsquo;s not going to be on the first try either. No, I&rsquo;ll milk this journey into a series of blog posts.</p><p>If you want to a see an actual complete and very thoroughly documented implementation of Forth, look no further than <a href="http://git.annexia.org/?p=jonesforth.git;a=blob;f=jonesforth.S;h=45e6e854a5d2a4c3f26af264dfce56379d401425;hb=HEAD">JONESFORTH</a>. If you didn&rsquo;t consider yourself a geek before, be warned that the ASCII art diagrams alone will turn you into one in no time.</p><h2 id=learn-forth>Learn Forth</h2><p>Don&rsquo;t know Forth? Don&rsquo;t worry, follow this <a href=https://learnxinyminutes.com/docs/forth/>5 mins tutorial</a> and try it out <a href=https://www.tutorialspoint.com/execute_forth_online.php>online</a>. Another great resource is <a href=https://skilldrick.github.io/easyforth/#introduction>Easy Forth</a>, which comes with an online REPL as well. If you want to go even deeper on the language, <a href=http://www.murphywong.net/hello/simple.htm>Simple Forth</a> is a classic.</p><p>The main thing you notice when you first see Forth code is that it uses <a href=https://en.wikipedia.org/wiki/Reverse_Polish_notation>Reverse Polish notation</a>. Where in other languages you would write <code>foo(bar(1 + 2 * 3))</code>, in Forth you might instead write <code>1 2 3 * + foo bar</code>. You&rsquo;d be forgiven to think that&rsquo;s a crazy way to go about things, and that you have better uses of your time than listening to this nonsense, but this notation has a few advantages:</p><ul><li>it&rsquo;s trivial to parse, just split on whitespace</li><li>you don&rsquo;t need to care about operator precedence</li><li>it&rsquo;s a fun, different, way to think<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li></ul><p>There is much more to the language than its syntax of course, but we&rsquo;ll talk about the important bits as we go along building our very own Forth.</p><h2 id=the-interpreter>The Interpreter</h2><p>For this little experiment, we&rsquo;ll be implementing the Forth interpreter / compiler in <a href=https://learnxinyminutes.com/docs/go/>Go</a>, for no other reason than I like how the title of this post gets to look like as a result. Because you know what they say, it&rsquo;s not worth doing if you&rsquo;re not having pun.</p><p>We&rsquo;ll start by building the basic interpreter loop. We will read the input code from stdin and split it into tokens separated by whitespace(s). We can do that quite neatly using <code>bufio</code> and the <code>ScanWords</code> split function. <code>ToLower</code> then forces our Forth to be case-insensitive, because shouting out commands at a computer is something crazy people do.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// goforth1.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;bufio&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdin</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>()))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>instr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Parsing &#39;%s&#39;.\n&#34;</span>, <span style=color:#a6e22e>instr</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can start our Forth interpreter and see that it properly parses our input:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go build -o goforth goforth1.go
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;1 2 + \n 2  -&#34;</span> | ./goforth
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;1&#39;</span>.
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;2&#39;</span>.
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;+&#39;</span>.
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;2&#39;</span>.
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;-&#39;</span>.
</span></span></code></pre></div><p>Congratulations are in order, we just built a full-blown language parser! Maybe it&rsquo;s not much of an achievement considering Forth is just about the easiest programming language to parse, but we take our wins where we can.</p><p>Our interpreter is now ready to start doing something actually useful.</p><h2 id=a-stack-of-numbers>A Stack of Numbers</h2><p>In Forth, a code instruction can either be a number (the data) or a word (a subroutine).<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> If it&rsquo;s a number, the interpret will immediately push it to a global stack, the parameter stack.</p><p>The <strong>stack</strong> is the main data structure we will be manipulating as we execute the code, pushing and pulling data from it. It looks something like this (you may be rightfully wincing at the usage of global variables and functions, but it will help with readability later on)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>STACK</span> = []<span style=color:#66d9ef>int</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// push one or more numbers to the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>x</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>int</span>) { 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>STACK</span> = append(<span style=color:#a6e22e>STACK</span>, <span style=color:#a6e22e>x</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// remove and return the number at the top of the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>pop</span>() (<span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>last</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>peek</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>STACK</span> = <span style=color:#a6e22e>STACK</span>[:len(<span style=color:#a6e22e>STACK</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>last</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// return the number at the top of the stack without poping it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>peek</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>STACK</span>[len(<span style=color:#a6e22e>STACK</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Distinguishing between numbers and words is trivially done by trying to parse a number and checking for failure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>instr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Parsing &#39;%s&#39;. &#34;</span>, <span style=color:#a6e22e>instr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>number</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>instr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// it&#39;s a number, push to stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>number</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Stack now looks like this:&#34;</span>, <span style=color:#a6e22e>STACK</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// it&#39;s a word, do something else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;I don&#39;t know any words yet&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The eagle-eyed<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> among you will notice we only have support for integers right now. Forth usually treats floating point numbers separately, with its own stack and words. That seems like it would be boring to implement, so I&rsquo;ll just leave that as an exercise to the reader.<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><p>Now we can run our little interpreter and see the stack grow and grow as we feed it numbers. In the next section we will implement the addition and subtraction operators that will consume from the stack and do something useful with it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;1 2 + \n 2  -&#34;</span> | ./goforth
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;1&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;2&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span><span style=color:#ae81ff>1</span> 2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;+&#39;</span>. I don<span style=color:#e6db74>&#39;t know any words yet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Parsing &#39;</span>2<span style=color:#e6db74>&#39;. Stack now looks like this: [1 2 2]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Parsing &#39;</span>-<span style=color:#e6db74>&#39;. I don&#39;</span>t know any words yet
</span></span></code></pre></div><h2 id=a-dictionary-of-words>A Dictionary of Words</h2><p>If a token, any sequence of non-whitespace characters, is not a number, it must be a word. A word is just the name for a subroutine, a piece of code that when executed manipulates the stack to do something useful. Let&rsquo;s take a look at an example.</p><p>We&rsquo;ll start by implementing <code>+</code>, the addition operator. Calling this word will pop the two numbers at the top of the stack and add them together, pushing the result back into the stack. A simple implementation would look like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>()  { 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pop</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pop</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>result</span>) 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>or in condensed form</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>()  { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>pop</span>()) }
</span></span></code></pre></div><p>Similarly for subtraction, <code>-</code> <a name=sub></a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>()  { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>pop</span>()) }
</span></span></code></pre></div><p>Now we will store these Go functions into a global dictionary that maps a word to their executable code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>WORDDEF</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>initWords</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WORDDEF</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(){
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;+&#34;</span>: <span style=color:#a6e22e>add</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-&#34;</span>: <span style=color:#a6e22e>sub</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We just need to make sure to initialize our dictionary at the start of our program.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initWords</span>()
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}    
</span></span></code></pre></div><p>From now on, when our interpreter encounters a word as it&rsquo;s parsing the Forth code stream, it will look for it in this dictionary. If it finds an entry, it executes the associated code straight away. If it doesn&rsquo;t find that word, it will, against the timeless advice of beloved sci-fi comedy author Douglas Adams, panic.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>instr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Parsing &#39;%s&#39;. &#34;</span>, <span style=color:#a6e22e>instr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>number</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>instr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// it&#39;s a number, push to stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>number</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>word</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>WORDDEF</span>[<span style=color:#a6e22e>instr</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// it&#39;s a word that we know, execute it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>word</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we don&#39;t know this word, error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Word &#39;%s&#39; doesn&#39;t exist&#34;</span>, <span style=color:#a6e22e>instr</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Stack now looks like this:&#34;</span>, <span style=color:#a6e22e>STACK</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now to test it</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;1 2 + \n 2  -&#34;</span> | ./goforth
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;1&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;2&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span><span style=color:#ae81ff>1</span> 2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;+&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span>3<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;2&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span><span style=color:#ae81ff>3</span> 2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Parsing <span style=color:#e6db74>&#39;-&#39;</span>. Stack now looks like this: <span style=color:#f92672>[</span>-1<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Great, as expected, the <code>+</code> word removes 1 and 2 from the stack, and puts 3 there instead. But, uh-oh, something&rsquo;s wrong with that subtraction operation. If we remember the wikipedia article from 5 minutes ago we know that <code>1 2 + 2 -</code> is Reverse Polish for <code>(1 + 2) - 2</code>, which, if we remember our first grade math, should resolve to <code>1</code>. Instead we get <code>-1</code>.</p><p>This is a silly bug we introduced in our Go implementation, the result of trying to optimize for the code looking symmetric and neat over it being correct. Remember our definition of <code>sub()</code> from <a href=#sub>above</a>, where we do <code>pop() - pop()</code>? Well, if we have a stack that looks like <code>[a b]</code> (i.e. <code>a</code> is at the bottom of the stack, <code>b</code> at the top), this operation first pops <code>b</code> and then pops and subtracts <code>a</code>, computing <code>b - a</code> in standard math notation. We actually want <code>a - b</code>.</p><p>Following a long lasting tradition of software development in the real world, we&rsquo;re just going to ignore this bug and move on to something else.</p><h2 id=some-more-words>Some More Words</h2><p>If you want to do anything useful in Forth you&rsquo;ll have to do some stack manipulation, and only a handful of simple definitions built into your interpreter is enough to get started. More advanced functionality can just be built with Forth itself!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>drop</span>()  { <span style=color:#a6e22e>pop</span>() }                                  <span style=color:#75715e>// ( a -- )
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dup</span>()   { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>peek</span>()) }                           <span style=color:#75715e>// ( a -- a a )
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>swap</span>()  { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>(), <span style=color:#a6e22e>pop</span>()) }                     <span style=color:#75715e>// ( a b -- b a )
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>rot</span>()   { <span style=color:#a6e22e>swap</span>(); <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>(), <span style=color:#a6e22e>pop</span>(), <span style=color:#a6e22e>pop</span>()) }      <span style=color:#75715e>// ( a b c -- b c a)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> clear() { <span style=color:#a6e22e>STACK</span> = <span style=color:#66d9ef>nil</span> }                            <span style=color:#75715e>// ( a b c -- )
</span></span></span></code></pre></div><p>The comments on the right are just the standard way to annotate words in Forth (although, of course, we&rsquo;re not actually <em>in</em> Forth yet, but I thought the sooner we get acquainted the better). These comments are meant to represent the state of the stack before and after the word is executed. For example, <code>swap</code> is a word that will swap the positions of the two top elements of the stack, thus if the stack looked like <code>[a b]</code>, after <code>swap</code> is applied, it will look like <code>[b a]</code>.</p><p>And speaking of <code>swap</code>, let&rsquo;s use it to fix the bug from before!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>subFixed</span>()  { <span style=color:#a6e22e>swap</span>(); <span style=color:#a6e22e>sub</span>() }                      <span style=color:#75715e>// ( a b -- a - b)
</span></span></span></code></pre></div><p>You&rsquo;d probably shutdown my bug fixing PR, signing off with the disappointed emoji and mournful words about the quality of devs these days. In my defense, it was done this way because the narrative <em>demanded it</em>. I wanted to illustrate how Forth programmers tend to think, building words on top of other words, manipulating the stack rather than storing things in variables.</p><p>Moving on with a few more useful words</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// pop and print the top of the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dot</span>() { <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>pop</span>()) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// print the whole stack without changing it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dots</span>() { <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>STACK</span>) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// exit Forth
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bye</span>() { <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>0</span>) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// print out all currently defined words
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>words</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>word</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>WORDDEF</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>word</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For completeness, let&rsquo;s add the rest of the arithmetic functions</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mult</span>() { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>pop</span>()) }                     <span style=color:#75715e>// ( a b -- a * b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>div</span>()  { <span style=color:#a6e22e>swap</span>(); <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>/</span> <span style=color:#a6e22e>pop</span>()) }             <span style=color:#75715e>// ( a b -- a / b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mod</span>()  { <span style=color:#a6e22e>swap</span>(); <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>%</span> <span style=color:#a6e22e>pop</span>()) }             <span style=color:#75715e>// ( a b -- a mod b)
</span></span></span></code></pre></div><p>&mldr;a few logical operators<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>not</span>() { <span style=color:#a6e22e>pushb</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)}                         <span style=color:#75715e>// ( a -- a == 0)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>equal</span>() { <span style=color:#a6e22e>pushb</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>pop</span>())}                   <span style=color:#75715e>// ( a b -- a == b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>land</span>() { <span style=color:#a6e22e>pushb</span>((<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)) }     <span style=color:#75715e>// ( a b -- a &amp;&amp; b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>lor</span>() { <span style=color:#a6e22e>pushb</span>((<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>||</span> (<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)) }      <span style=color:#75715e>// ( a b -- a || b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>lt</span>()  { <span style=color:#a6e22e>swap</span>(); <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() &lt; <span style=color:#a6e22e>pop</span>()) }              <span style=color:#75715e>// ( a b -- a &lt; b)
</span></span></span></code></pre></div><p>&mldr;and let&rsquo;s not forget our bitwise friends</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>and</span>() { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>pop</span>())}                       <span style=color:#75715e>// (a b -- a &amp; b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>or</span>() { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() | <span style=color:#a6e22e>pop</span>())}                        <span style=color:#75715e>// (a b -- a | b)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>xor</span>() { <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>pop</span>() ^ <span style=color:#a6e22e>pop</span>())}                       <span style=color:#75715e>// (a b -- a ^ b)
</span></span></span></code></pre></div><p>Then we make sure to register them all so they are accessible from Forth</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>initWords</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WORDDEF</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(){
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;drop&#34;</span>: <span style=color:#a6e22e>drop</span>, <span style=color:#e6db74>&#34;dup&#34;</span>: <span style=color:#a6e22e>dup</span>, <span style=color:#e6db74>&#34;swap&#34;</span>: <span style=color:#a6e22e>swap</span>, <span style=color:#e6db74>&#34;rot&#34;</span>: <span style=color:#a6e22e>rot</span>, <span style=color:#e6db74>&#34;clear&#34;</span>: <span style=color:#a6e22e>clear</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;+&#34;</span>: <span style=color:#a6e22e>add</span>, <span style=color:#e6db74>&#34;-&#34;</span>: <span style=color:#a6e22e>subFixed</span>, <span style=color:#e6db74>&#34;*&#34;</span>: <span style=color:#a6e22e>mult</span>, <span style=color:#e6db74>&#34;/&#34;</span>: <span style=color:#a6e22e>div</span>, <span style=color:#e6db74>&#34;mod&#34;</span>: <span style=color:#a6e22e>mod</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;not&#34;</span>: <span style=color:#a6e22e>not</span>, <span style=color:#e6db74>&#34;=&#34;</span>: <span style=color:#a6e22e>equal</span>, <span style=color:#e6db74>&#34;land&#34;</span>: <span style=color:#a6e22e>land</span>, <span style=color:#e6db74>&#34;lor&#34;</span>: <span style=color:#a6e22e>lor</span>, <span style=color:#e6db74>&#34;&lt;&#34;</span>: <span style=color:#a6e22e>lt</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;and&#34;</span>: <span style=color:#a6e22e>and</span>, <span style=color:#e6db74>&#34;or&#34;</span>: <span style=color:#a6e22e>or</span>, <span style=color:#e6db74>&#34;xor&#34;</span>: <span style=color:#a6e22e>xor</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;.&#34;</span>: <span style=color:#a6e22e>dot</span>, <span style=color:#e6db74>&#34;.s&#34;</span>: <span style=color:#a6e22e>dots</span>, <span style=color:#e6db74>&#34;bye&#34;</span>: <span style=color:#a6e22e>bye</span>, <span style=color:#e6db74>&#34;words&#34;</span>: <span style=color:#a6e22e>words</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That was a lot of copy and pasting going around. Let&rsquo;s try it out finally</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;1 2 + 2 - . &#34;</span> | ./goforth
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;1 2 3 rot .s &#34;</span> | ./goforth
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> 1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;6 6 6 * swap / . &#34;</span> | ./goforth
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>
</span></span></code></pre></div><p>We&rsquo;re practically done! This is about as many words as you need to pre-define using the native language of your interpreter,<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> which in our case is Go. The rest of the words that make a standard Forth implementation can be implemented in Forth itself. This is called bootstrapping Forth, and it&rsquo;s a thing of beauty!</p><p>But wait, how do we define words from within Forth? We need just a couple more words, then we&rsquo;re done, I promise. Well, for now.</p><h2 id=in-your-own-words>In Your Own Words</h2><p>In Forth, you create a new word by using a sequence in the format <code>: NAME &lt;code> ;</code>. For example, this creates a word that increments the number at the top of the stack by 1:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Forth data-lang=Forth><span style=display:flex><span><span style=color:#f92672>:</span> <span style=color:#a6e22e>inc</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>+ ;
</span></span></span></code></pre></div><p>And we can use it like so</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Forth data-lang=Forth><span style=display:flex><span><span style=color:#ae81ff>10</span> <span style=color:#a6e22e>inc</span> <span style=color:#66d9ef>. </span>
</span></span></code></pre></div><p>This prints out 11.</p><p>But how does the interpreter actually know that when it sees something between <code>:</code> and <code>;</code> it&rsquo;s supposed to compile it into a new word? Remember before when we discussed how the interpreter parses a token and immediately does something with it, either adding a number to the stack or executing a word? This is true when the system is in the <strong>interpret</strong> mode (sometimes called <strong>immediate</strong> mode). But there is an alternate <strong>compile</strong> mode, where the parsed tokens, rather than being executed, get added to the body of a word currently being compiled.</p><p>Let&rsquo;s first define a global variable to control in which of the states our interpreter is</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>STATE</span> = <span style=color:#ae81ff>0</span>  <span style=color:#75715e>// 0 - interpret mode, 1 - compile mode
</span></span></span></code></pre></div><p>We&rsquo;ll also need a temporary container, the compile body, which will hold the tokens that we see when we&rsquo;re in compile mode (everything between <code>:</code> and <code>;</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>CBODY</span> = []<span style=color:#66d9ef>string</span>{}
</span></span></code></pre></div><p>Let&rsquo;s go ahead and incorporate these new concepts into our main loop</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>instr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>STATE</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>instr</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// compile mode, add to compile body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>CBODY</span> = append(<span style=color:#a6e22e>CBODY</span>, <span style=color:#a6e22e>instr</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>number</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>instr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// it&#39;s a number, push to stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>number</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>word</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>WORDDEF</span>[<span style=color:#a6e22e>instr</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// it&#39;s a word that we know, execute it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>word</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we don&#39;t know this word, error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Word &#39;%s&#39; doesn&#39;t exist&#34;</span>, <span style=color:#a6e22e>instr</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we just need to implement <code>:</code>, which simply puts the interpreter into compile mode,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startCompile</span>() { 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>STATE</span> = <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and then <code>;</code>, which ends the compilation, takes the compile body, and creates a new entry in our dictionary</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>endCompile</span>() { 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wordname</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CBODY</span>[<span style=color:#ae81ff>0</span>] <span style=color:#75715e>// first token in CBDOY is the word
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>instructions</span> <span style=color:#f92672>:=</span> append([]<span style=color:#66d9ef>string</span>{}, <span style=color:#a6e22e>CBODY</span>[<span style=color:#ae81ff>1</span>:]<span style=color:#f92672>...</span>) <span style=color:#75715e>// copy CBODY[1:] into new slice
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>CBODY</span> = <span style=color:#66d9ef>nil</span> <span style=color:#75715e>// reset the compile body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// build the new function that, when executed, will execute `instructions`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>WORDDEF</span>[<span style=color:#a6e22e>wordname</span>] = <span style=color:#66d9ef>func</span>() { 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>instr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>instructions</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>instr</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>STATE</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// go back to interpret mode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Don&rsquo;t forget, as always, to add <code>:</code> and <code>;</code> to the word dictionary</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>initWords</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WORDDEF</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(){
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;:&#34;</span>: <span style=color:#a6e22e>startCompile</span>, <span style=color:#e6db74>&#34;;&#34;</span>: <span style=color:#a6e22e>endCompile</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>Notice that in our latest version of <code>exec</code> we had to make a special case for when we&rsquo;re in compile mode (<code>STATE=1</code>) and see the word <code>;</code>. This is because words don&rsquo;t get executed in compile mode, you&rsquo;ll remember, so we&rsquo;d never get to actually run the code inside <code>end_compile()</code> that flips back <code>STATE</code>, and we&rsquo;d just continue merrily compiling until we run out of input.</p><p>If you thought this special condition <code>instr != ";"</code> has the tiniest of hints of code smell, then you should be proud of your metaphorical digital nose. It&rsquo;s a poor way to implement this behavior. Instead, Forth defines the more general concept of an <strong>immediate</strong> word, which is a word that, regardless of the current state, gets executed immediately when parsed. We&rsquo;ll see in future blog posts how immediate words are useful to implement all kinds of neat things in Forth.</p><p>And to test it out</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;: inc 1 + ; 10 inc . &#34;</span> | ./goforth
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>
</span></span></code></pre></div><p>Success!</p><h2 id=last-words>Last Words</h2><p>That&rsquo;s all for now, we got a decently working Forth implementation going. We have a parser, some predefined words, a working compiler for new words. All in less than 150 lines of Go! I bet you could do some useful work with it already.</p><p><a href=https://gist.github.com/jotinha/3d84b738d52a2e9ef6e4fdcde0e2149a>Here&rsquo;s the whole code</a> used in this tutorial.</p><p>In the next episode of this series we&rsquo;ll talk about branching and how we can implement IF statements and FOR loops using pure Forth. That&rsquo;s right, where other languages do all the legwork of providing native control structures, wrapped up with a nice little bow of syntactic sugar, right from the comfortable pedestal of high levelness from which laziness spawns, in Forth, you roll your own. And then you prosper.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>And really, we should challenge our brains more and our CPUs less.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Some might say a number is also a word, but then I might say please ignore these people who want to ruin the blog post I had half written when I realized they were right.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Or gopher-eyed.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Only people who care about money, science, engineering, and everything else really, need useless features like these anyway. You can&rsquo;t divide <em>people</em> into fractions, man.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><code>push</code> expects an int, so we had to define a new <code>pushb</code> which works with boolean arguments.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>There probably exists a smaller theoretical set of instructions you could bootstrap from, but that&rsquo;s more of an academic question, this is a good practical set. There are still a few important ones missing, but we&rsquo;ll leave that for another time.&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#background>Background</a></li><li><a href=#learn-forth>Learn Forth</a></li><li><a href=#the-interpreter>The Interpreter</a></li><li><a href=#a-stack-of-numbers>A Stack of Numbers</a></li><li><a href=#a-dictionary-of-words>A Dictionary of Words</a></li><li><a href=#some-more-words>Some More Words</a></li><li><a href=#in-your-own-words>In Your Own Words</a></li><li><a href=#last-words>Last Words</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&text=Go%20Forth%20and%20Prosper" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&title=Go%20Forth%20and%20Prosper" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&is_video=false&description=Go%20Forth%20and%20Prosper" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Go%20Forth%20and%20Prosper&body=Check out this article: %2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&title=Go%20Forth%20and%20Prosper" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&title=Go%20Forth%20and%20Prosper" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&name=Go%20Forth%20and%20Prosper&description=TL%3bDR%20Split%20input%20on%20white%20space%20Numbers%20get%20added%20to%20a%20stack%2c%20words%20get%20executed%20Pre-define%20some%20words%20in%20the%20interpreter%20Write%20new%20words%20in%20Forth%20Background%20For%20last%20year%26rsquo%3bs%20Advent%20of%20Code%2c%20in%20one%20of%20those%20should-really-stop-overestimating-my-skills%20type%20of%20situations%2c%20I%20took%20on%20the%20challenge%20of%20using%20a%20different%20programming%20language%20every%20day.%20Needless%20to%20say%2c%20a%20day%20quickly%20took%20on%20a%20looser%20definition%20as%20the%20problems%20got%20progressively%20harder%20and%20the%20languages%20more%20esoteric." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=%2f%2fwww.jgsousa.com%2fposts%2fgo-forth-and-prosper%2f&t=Go%20Forth%20and%20Prosper" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 João G. Sousa</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>